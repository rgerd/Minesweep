function loadImage(a){var b=new Image;return imagesToLoad++,b.onload=function(){imagesToLoad--,0==imagesToLoad&&init()},b.src=a,b}function init(){if(pageLoaded&&!(imagesToLoad>0)){socket=io(),canvas=document.getElementById("game_screen"),canvas.addEventListener("mousemove",_mouseMove),canvas.addEventListener("mousedown",_mouseDown),canvas.addEventListener("mouseup",_mouseUp),canvas.addEventListener("mouseout",_mouseOut),ctx=canvas.getContext("2d"),ctx.imageSmoothingEnabled=!1,ctx.mozImageSmoothingEnabled=!1,ctx.webkitImageSmoothingEnabled=!1,ctx.msImageSmoothingEnabled=!1,ctx.setTransform(4,0,0,4,8,0),ctx.fillStyle="black",toolbar=document.getElementById("toolbar"),bombCount=document.getElementById("bomb-count"),resetButton=document.getElementById("reset-button"),resetButton.addEventListener("mousedown",function(){player.host&&sendReset()}),timer=document.getElementById("timer"),messageInput=document.getElementById("message_input"),messageInput.addEventListener("keydown",function(a){if(13==a.which){var b=messageInput.value.trim();if(0==b.length)return;sendMessage(b),messageInput.value=""}}),onlinePlayerNames=document.getElementById("players_online"),hostPlayerName=document.getElementById("host"),initGame();var a=Math.floor(8*Math.random()),b=Math.floor(16777215*Math.random()).toString(16);player={name:b,color:a},initSocketListeners(),tick()}}function tick(){requestAnimationFrame(tick),updateCanvas(),update(),render()}function updateCanvas(){var a=window.innerWidth,b=window.innerHeight,c=a*canvasPercent;c=Math.max(Math.min(c,canvasMaxSize),canvasMinSize);var d=b*canvasPercent;d=Math.max(Math.min(d,canvasMaxSize),canvasMinSize);var e=Math.min(c,d);cd=Math.floor(e-e%2),canvas.width=e,canvas.height=e,toolbar.style.width=canvas.width+2+"px"}function getZoom(){var a=canvas.width/(numTiles*tileSize);return a}function getMousePos(a){var b=canvas.getBoundingClientRect();return{x:a.clientX-b.left,y:a.clientY-b.top}}function _mouseMove(a){mouse=getMousePos(a)}function _mouseOut(a){mouse={x:-1,y:-1},checkForPositionUpdate(),mouseLeft=!1,mouseRight=!1}function _mouseDown(a){mouse=getMousePos(a);var b=toTileCoords(mouse.x,mouse.y);return 0==a.button&&(mouseLeft=!0,downTile={x:b.x,y:b.y},(boardGenerated||player.host)&&(leftClickTile(b,!0),sendClick(!0,!0,b.x,b.y))),2==a.button&&(mouseRight=!0,(boardGenerated||player.host)&&(rightClickTile(b,!0),sendClick(!1,!0,b.x,b.y))),!1}function _mouseUp(a){mouse=getMousePos(a);var b=toTileCoords(mouse.x,mouse.y);return 0==a.button&&(mouseLeft=!1,downTile={x:-1,y:-1},(boardGenerated||player.host)&&(dragging||(leftClickTile(b,!1),sendClick(!0,!1,b.x,b.y)))),2==a.button&&(mouseRight=!1,(boardGenerated||player.host)&&(rightClickTile(b,!1),sendClick(!1,!1,b.x,b.y))),dragging&&(dragging=!1),!1}function leftClickTile(a,b){if(b=1==b,!game_state.game_over&&tileValid(a)){var c=board[a.x+a.y*numTiles];c.state==UNCOVERED?b&&(c.bombsAdj!=numAdjFlagged(a.x,a.y)||c.isBomb||uncoverSurroundingTiles(a.x,a.y)):c.state==COVERED&&(b?c.down=!0:(boardGenerated?uncoverTile(a.x,a.y):(generateBoard(a.x,a.y),uncoverTile(a.x,a.y),broadcastBoard()),c.down=!1))}}function rightClickTile(a,b){if(b=1==b,!game_state.game_over&&tileValid(a)){var c=a.x+a.y*numTiles,d=board[c];d.state!=UNCOVERED&&boardGenerated&&b&&(d.state=d.state==FLAGGED?COVERED:FLAGGED,unflagged+=d.state==FLAGGED?-1:1)}}function initGame(){game_state={game_over:!1,details:"",bombsUncovered:!1},startTime=-1,endTime=-1,unflagged=-1,hitBomb={x:-1,y:-1},timer.innerHTML="000",timesUp=!1,document.getElementById("toolbar").style.color="white",initBoard()}function initBoard(){board=new Array;for(var a=0;numTiles*numTiles>a;a++)board[a]={isBomb:!1,state:COVERED,bombsAdj:0,down:!1,correct:!1};boardGenerated=!1}function generateBoard(a,b){if(!boardGenerated){for(var c=0;numBombs>c;c++){var d=Math.floor(Math.random()*numTiles*numTiles),e=d%numTiles,f=Math.floor(d/numTiles);Math.abs(e-a)<=1&&Math.abs(f-b)<=1||(board[d].isBomb=!0)}for(var d=0;numTiles>d;d++)for(var g=0;numTiles>g;g++)for(var h=d+g*numTiles,i=-1;1>=i;i++)for(var j=-1;1>=j;j++)if(0!=i||0!=j){var k=i+d,l=j+g;0>k||k>=numTiles||0>l||l>=numTiles||(board[h].bombsAdj+=board[k+l*numTiles].isBomb?1:0)}unflagged=numBombs,boardGenerated=!0,startTime=(new Date).getTime()}}function tileValid(a){return a.x>=0&&a.y>=0&&a.x<numTiles&&a.y<numTiles}function numAdjFlagged(a,b){for(var c=0,d=-1;1>=d;d++)for(var e=-1;1>=e;e++)if(0!=d||0!=e){var f=d+a,g=e+b;0>f||f>=numTiles||0>g||g>=numTiles||(c+=board[f+g*numTiles].state==FLAGGED?1:0)}return c}function toTileCoords(a,b){var c=getZoom(),d=numTiles*tileSize*c,e=canvas.width/2-d/2,f=canvas.height/2-d/2;return{x:Math.floor((a-e)/c/tileSize),y:Math.floor((b-f)/c/tileSize)}}function numToSheetCoords(a){return 0==a?{x:3,y:0}:(a--,{x:a%4+0,y:Math.floor(a/4)+3})}function uncoverTile(a,b){var c=board[a+b*numTiles];c.state!=UNCOVERED&&c.state==COVERED&&(c.state=UNCOVERED,0!=c.bombsAdj||c.isBomb||uncoverSurroundingTiles(a,b),c.isBomb&&-1==hitBomb.x&&-1==hitBomb.y&&(hitBomb={x:a,y:b},game_state.game_over=!0,game_state.details="bomb_found",uncoverAllBombs()))}function uncoverSurroundingTiles(a,b){for(var c=-1;1>=c;c++)for(var d=-1;1>=d;d++)if(0!=c||0!=d){var e=c+a,f=d+b;0>e||e>=numTiles||0>f||f>=numTiles||board[e+f*numTiles].state!=UNCOVERED&&uncoverTile(e,f)}}function uncoverAllBombs(){if(!game_state.bombsUncovered){game_state.bombsUncovered=!0;for(var a=0;numTiles*numTiles>a;a++)board[a].isBomb&&(board[a].state==FLAGGED&&(board[a].correct=!0),board[a].state=UNCOVERED);printGameOver()}}function printGameOver(a){a=1==a,a||printMessage("<span style='font-weight:bold;color:#CC2222;'>GAME OVER!</span>"),printMessage(player.host?"<span style='font-weight:bold;'>Press the refresh button in the middle of the toolbar to restart the game.</span>":"<span style='font-weight:bold;'>Waiting for the host to restart the game...</span>")}function printStartGame(){printMessage(player.host?"<span style='font-weight:bold;'>Click a tile to start the game!</span>":"<span style='font-weight:bold;'>Waiting for host to start the game...</span>")}function releaseTile(a,b){tileValid({x:a,y:b})&&(board[a+b*numTiles].down=!1)}function updateTimer(){var a=-1!=endTime?endTime:(new Date).getTime(),b=Math.floor((a-startTime)/1e3);b=b>999?999:b,999==b&&(game_state.game_over=!0,game_state.details="times_up",uncoverAllBombs()),timer.innerHTML=Math.floor(b/100)+""+Math.floor(b%100/10)+b%10}function update(){var a=toTileCoords(mouse.x,mouse.y);mouseLeft&&tileValid(downTile)&&(a.x!=downTile.x||a.y!=downTile.y)&&(releaseTile(downTile.x,downTile.y),sendTileRelease(downTile.x,downTile.y),downTile={x:-1,y:-1},dragging=!0),boardGenerated?parseInt(bombCount.innerHTML)!=unflagged&&(bombCount.innerHTML=unflagged+""):bombCount.innerHTML="??",game_state.game_over&&-1==endTime&&(endTime=(new Date).getTime()),-1==startTime||game_state.game_over||updateTimer(),game_state.game_over&&(document.getElementById("toolbar").style.color="#f33"),checkForPositionUpdate()}function render(){var a=getZoom();ctx=canvas.getContext("2d"),ctx.imageSmoothingEnabled=!1,ctx.mozImageSmoothingEnabled=!1,ctx.webkitImageSmoothingEnabled=!1,ctx.msImageSmoothingEnabled=!1,ctx.setTransform(a,0,0,a,0,0);for(var b=numTiles*tileSize*a,c=(canvas.width/2-b/2)/a,d=(canvas.height/2-b/2)/a,e=toTileCoords(mouse.x,mouse.y),f=0;numTiles>f;f++)for(var g=0;numTiles>g;g++){var h=f*tileSize+c,i=g*tileSize+d,j=f+g*numTiles,k=board[j];switch(k.state){case COVERED:k.down?ctx.drawImage(sheet,1*tileSize,0*tileSize,tileSize,tileSize,h,i,tileSize,tileSize):ctx.drawImage(sheet,0*tileSize,0*tileSize,tileSize,tileSize,h,i,tileSize,tileSize);break;case UNCOVERED:if(board[j].isBomb)hitBomb.x==f&&hitBomb.y==g||"times_up"==game_state.details?ctx.drawImage(sheet,1*tileSize,3*tileSize,tileSize,tileSize,h,i,tileSize,tileSize):game_state.game_over&&k.correct?ctx.drawImage(sheet,2*tileSize,3*tileSize,tileSize,tileSize,h,i,tileSize,tileSize):ctx.drawImage(sheet,0*tileSize,3*tileSize,tileSize,tileSize,h,i,tileSize,tileSize);else{var l=board[j].bombsAdj;0==l?ctx.drawImage(sheet,3*tileSize,0*tileSize,tileSize,tileSize,h,i,tileSize,tileSize):ctx.drawImage(sheet,tileSize*(board[j].bombsAdj-1),2*tileSize,tileSize,tileSize,h,i,tileSize,tileSize)}break;case FLAGGED:game_state.game_over&&!k.correct?ctx.drawImage(sheet,5*tileSize,0*tileSize,tileSize,tileSize,h,i,tileSize,tileSize):ctx.drawImage(sheet,4*tileSize,0*tileSize,tileSize,tileSize,h,i,tileSize,tileSize)}for(var m=0;m<players.length;m++){var n=players[m];f==n.x&&g==n.y&&ctx.drawImage(sheet,tileSize*n.color,1*tileSize,tileSize,tileSize,h,i,tileSize,tileSize)}f==e.x&&g==e.y&&ctx.drawImage(sheet,tileSize*player.color,1*tileSize,tileSize,tileSize,h,i,tileSize,tileSize)}}function sendClientData(){socket.emit("client_info",player)}function finalizeClientData(a){player=a,printMessage("Welcome, you are "+getNameHTML(player.name,player.color)),player.host?(printMessage("You are the host."),updateHost(player),$("#reset-button").removeClass("disabled")):$("#reset-button").addClass("disabled")}function printMessage(a){$("#message_board").append(a+"<hr />");var b=document.getElementById("message_board");b.scrollTop=b.scrollHeight}function getNameHTML(a,b,c){return c=1==c,"<span class='name"+(c?" stacked":"")+(a==player.name?" user":"")+"' style='color: "+colors[b]+"'>"+a+"</span>"}function checkForPositionUpdate(){var a=toTileCoords(mouse.x,mouse.y);(a.x!=last_mouse.x||a.y!=last_mouse.y)&&(last_mouse={x:a.x,y:a.y},sendUpdate())}function sendUpdate(){var a=toTileCoords(mouse.x,mouse.y);socket.emit("update",{_type:"position",x:a.x,y:a.y})}function sendClick(a,b,c,d){socket.emit("update",{_type:"click",left:a,down:b,x:c,y:d})}function onUpdate(a){switch(a._type){case"position":updatePosition(a);break;case"click":onClick(a);break;case"tile_release":releaseTile(a.x,a.y)}}function sendTileRelease(a,b){socket.emit("update",{_type:"tile_release",x:a,y:b})}function updatePosition(a){for(var b=0;b<players.length;b++)players[b].id==a.id&&(players[b].x=a.x,players[b].y=a.y)}function onClick(a){1==a.left?leftClickTile({x:a.x,y:a.y},a.down):rightClickTile({x:a.x,y:a.y},a.down)}function newPlayer(a){players.push(a),player.host&&boardGenerated&&sendBoard(a.id);var b="Player "+getNameHTML(a.name,a.color)+"  is connected.";printMessage(b),updatePlayerNames()}function deletePlayer(a){for(var b=0;b<players.length;b++)players[b].id==a.id&&players.splice(b,1);var c="Player "+getNameHTML(a.name,a.color)+"  has disconnected.";printMessage(c),updatePlayerNames()}function setBoard(a){console.log("Setting board..."),board=a.tiles,startTime=a.startTime,endTime=a.endTime,numBombs=a.numBombs,unflagged=numBombs,numTiles=a.numTiles,boardGenerated=!0,game_state=a.game_state,hitBomb=a.hitBomb,updateTimer(),-1!=endTime?printGameOver():-1==startTime&&printStartGame()}function resetGame(){initGame()}function sendReset(){socket.emit("game_reset")}function sendBoard(a){var b=getBoardData();console.log(b),b.dest=a,socket.emit("board_data",b)}function broadcastBoard(){socket.emit("init_board_data",getBoardData())}function getBoardData(){return{tiles:board,startTime:startTime,endTime:endTime,boardGenerated:boardGenerated,numBombs:numBombs,numTiles:numTiles,hitBomb:hitBomb,game_state:game_state}}function becomeHost(){player.host=!0,$("#reset-button").removeClass("disabled"),printMessage("You are the new host.")}function sendMessage(a){a=a.replace(/</g,"&lt;"),a=a.replace(/>/g,"&gt;"),socket.emit("send_message",{name:player.name,color:player.color,message:a})}function displayMessage(a){printMessage(getNameHTML(a.name,a.color)+": "+a.message)}function updatePlayerNames(){onlinePlayerNames.innerHTML="";for(var a=getNameHTML(player.name,player.color,!0),b=0;b<players.length;b++)a+=getNameHTML(players[b].name,players[b].color,!0);onlinePlayerNames.innerHTML=a}function updateHost(a){hostPlayerName.innerHTML=getNameHTML(a.name,a.color,!0)}function initSocketListeners(){socket.on("update",onUpdate),socket.on("client_info_final",finalizeClientData),socket.on("person_connect",newPlayer),socket.on("person_disconnect",deletePlayer),socket.on("force_update",sendUpdate),socket.on("board_data",setBoard),socket.on("connect",sendClientData),socket.on("become_host",becomeHost),socket.on("set_host",updateHost),socket.on("game_reset",resetGame),socket.on("message",displayMessage)}var COVERED="covered",UNCOVERED="uncovered",FLAGGED="flagged",colors=["#B63030","#FF7F44","#FFFF44","#44FF44","#2222FF","#44FFFF","#FC87FF","#6C3002"],sheet=loadImage("../images/art.png"),tileSize=16,toolbar,bombCount,resetButton,timer,hostPlayerName,onlinePlayerNames,messageInput,mouse={x:-1,y:-1},downTile={x:-1,y:-1},mouseLeft=!1,mouseRight=!1,dragging=!1,canvas,ctx,canvasPercent=.75,canvasMinSize=256,canvasMaxSize=1028,startTime,endTime,board,boardGenerated,hitBomb,numTiles=28,numBombs=160,unflagged,game_state,socket,player,players=[],pageLoaded=!1;$(function(){pageLoaded=!0,init()});var imagesToLoad=0,last_mouse={x:-1,y:-1};